<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Android-MediaExtractor&amp;MediaCodec，硬解码音视频"><meta name="keywords" content="Media"><meta name="author" content="WuShaohong"><meta name="copyright" content="WuShaohong"><title>Android-MediaExtractor&amp;MediaCodec，硬解码音视频 | WuShaohongのBlog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="WuShaohongのBlog" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E8%A7%A3%E7%A0%81%E9%9F%B3%E8%A7%86%E9%A2%91"><span class="toc-number">1.</span> <span class="toc-text">硬解码音视频</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MediaExtractor"><span class="toc-number">1.1.</span> <span class="toc-text">MediaExtractor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MediaCodec"><span class="toc-number">1.2.</span> <span class="toc-text">MediaCodec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E3%80%81%E8%A7%A3%E7%A0%81%E5%92%8C%E6%92%AD%E6%94%BE%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">分离、解码和播放的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6%EF%BC%8C%E5%88%86%E7%A6%BB%E9%9F%B3%E8%A7%86%E9%A2%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">读取媒体文件，分离音视频</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96Codec"><span class="toc-number">1.3.2.</span> <span class="toc-text">初始化Codec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96AudioTrack"><span class="toc-number">1.3.3.</span> <span class="toc-text">初始化AudioTrack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E7%A0%81"><span class="toc-number">1.3.4.</span> <span class="toc-text">解码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%B8%B2%E6%9F%93"><span class="toc-number">1.3.5.</span> <span class="toc-text">视频渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE"><span class="toc-number">1.3.6.</span> <span class="toc-text">音频播放</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5"><span class="toc-number">1.3.7.</span> <span class="toc-text">音视频同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.3.8.</span> <span class="toc-text">进度设置</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">WuShaohong</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">7</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1602489080558&amp;di=0dbbed72cc7f877b951b367d4a9ed292&amp;imgtype=0&amp;src=http%3A%2F%2Fattach.bbs.miui.com%2Fforum%2F201504%2F05%2F094406wb74eokgpu7fuxnz.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">WuShaohongのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/hexo-blog/">搜索</a><a class="site-page" href="/hexo-blog/">首页</a><a class="site-page" href="/hexo-blog/categories/">分类</a><a class="site-page" href="/hexo-blog/tags/">标签</a><a class="site-page" href="/hexo-blog/archives/">时间轴</a><a class="site-page" href="/hexo-blog/about/">关于</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Android-MediaExtractor&amp;MediaCodec，硬解码音视频</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-12-29</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 10 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>一、硬解码播放：“硬解”是硬件解码的简称。简单而言，硬件解码就是通过显卡的视频加速功能对高清视频进行解码。因此硬解能够将 CPU从繁重的视频解码运算中释放出来，使电视具备流畅播放高清视频的能力。显卡的 GPU/VPU要比 CPU更适合这类大数据量的、低难度的重复工作。视频解码工作从处理器那里分离出来，交给显卡去做，这就叫做“硬解码”。<br>二、硬解码的优势：硬解码的优势就在于可以流畅的支持 1080p甚至 4K清晰度的电影播放，而不需要占用 CPU，CPU就可以如释重负，轻松上阵，承担更多的其他任务。如果通过软解码的方式播放高清电影，CPU的负担较重，往往会出现卡顿、不流畅的现象。<br>硬件解码是将原来全部交由 CPU来处理的视频数据的一部分交由 GPU来做，而 GPU的并行运算能力要远远高于CPU，这样可以大大的降低对CPU的负载，CPU的占用率较低了之后就可以同时运行一些其他的程序了，当然，对于较好的处理器来说，硬解和软件的区别只是个人偏好问题了吧。<br>三、硬解码的劣势：<br>1：起步较晚，软件支持度无法与软解相提并论；<br>2：面对杂乱无章的视频编码、封装格式，硬解码无法做到全面兼容；<br>3：软解拥有大量画面输出补偿及画质增强技术，而硬解这方面做得还远远不够；<br>4：硬解码软件设置较为复杂，很多朋友根本不知道该如何正确使用GPU硬件解码。</p>
<h2 id="硬解码音视频"><a href="#硬解码音视频" class="headerlink" title="硬解码音视频"></a>硬解码音视频</h2><h3 id="MediaExtractor"><a href="#MediaExtractor" class="headerlink" title="MediaExtractor"></a><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/android/media/MediaExtractor">MediaExtractor</a></h3><p>官方定义：媒体提取器（分离），MediaExtractor有助于从数据源提取已解复用的，通常经过编码的媒体数据。</p>
<p>通常，我们看的电影”视频“文件（严格来说，应该称之为媒体文件，后文称媒体文件，为了区分视频和音频），很多都是多语双字幕（多种配音，中英双字幕）。多语的意思就是多种音频轨道，可以理解为内部有多个配音文件，在日常一般情况，视频轨道只有一个轨道。MediaExtractor的作用就是把媒体文件的音频和视频数据进行分离提取。</p>
<p>分离，按轨道 Track分离；读取，在分离的前提进行buffer的帧读取（逐帧读取）</p>
<p>常用 Api</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置数据源，即可以本地文件又可以网络文件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(String path)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 获取源文件通道数（轨道数）</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getTrackCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 通过index获取对于的媒体轨道格式 TrackFormat</span></span></span><br><span class="line"><span class="function">MediaFormat <span class="title">getTrackFormat</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 切换到指定媒体轨道，index下标</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectTrack</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 获取当前的读取游标的时间戳（读取进度时间戳）</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getSampleTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 读取一帧到 byteBuf当中，offse t数据按偏移量</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">readSampleData</span><span class="params">(ByteBuffer byteBuf, <span class="keyword">int</span> offset)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 游标移动到下一帧</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">advance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 释放资源</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>



<h3 id="MediaCodec"><a href="#MediaCodec" class="headerlink" title="MediaCodec"></a><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/kotlin/android/media/MediaCodec">MediaCodec</a></h3><p>MediaCodec是Android 4.1(api 16)版本引入的编解码接口，同时支持音视频的编码和解码。</p>
<p><img src="/2020/12/29/Android-MediaExtractor&MediaCodec/1.webp" alt="官方数据流图"></p>
<p>由图不难看出，输入端的 Client不断从 Codec当中申请空闲的 input buff，将音视频数据填充到 input buff，交由 Codec进行解码处理；输出端的 Client不断从 Codec当中取出解码后的 buff数据，进行后续处理。</p>
<p>Codec的解码分两种方式，同步和异步，同步的方式大致是：input和output在同一线程，输出数据后需要输出处理后才进行下一次输入。异步：input和 output分离独立。具体参考官网例子。本文使用的是同步方式。</p>
<p>无论是音频还是视频，解码的流程都大致如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--------------初始化解码---------------*/</span></span><br><span class="line"><span class="comment">// 1、创建解码器</span></span><br><span class="line"><span class="function">MediaCodec <span class="title">createDecoderByType</span><span class="params">(<span class="meta">@NonNull</span> String type)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 2、配置解码器格式等</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">configure</span><span class="params">(<span class="meta">@Nullable</span> MediaFormat format, <span class="meta">@Nullable</span> Surface surface, <span class="meta">@Nullable</span> MediaCrypto crypto, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 3、开启解码</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">/*--------------初始化解码---------------*/</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*---------------循环解码----------------*/</span></span></span><br><span class="line"><span class="function"><span class="comment">// 4、获取 codec 空闲的 input buffer的 index</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dequeueInputBuffer</span><span class="params">(<span class="keyword">long</span> timeoutUs)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 5、获取对应 index的 input buffer</span></span></span><br><span class="line"><span class="function">ByteBuffer <span class="title">getInputBuffer</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 6、将输入数据存到 input buffer当中</span></span></span><br><span class="line"><span class="function">...</span></span><br><span class="line"><span class="function"><span class="comment">// 7、输入数据入队</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">queueInputBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> presentationTimeUs, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 8、获取 codec 解码完成的输出 buffer的 index</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dequeueOutputBuffer</span><span class="params">(<span class="meta">@NonNull</span> MediaCodec.BufferInfo info, <span class="keyword">long</span> timeoutUs)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 9、释放输出的 buffer</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseOutputBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">boolean</span> render)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*---------------循环解码----------------*/</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*---------------释放解码----------------*/</span></span></span><br><span class="line"><span class="function"><span class="comment">// 10、停止解码</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 11、释放资源</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">/*---------------释放解码----------------*/</span></span></span><br></pre></td></tr></table></figure>



<h3 id="分离、解码和播放的实现"><a href="#分离、解码和播放的实现" class="headerlink" title="分离、解码和播放的实现"></a>分离、解码和播放的实现</h3><p>SurfaceView渲染视频，AudioTrack播放解码的 PCM。</p>
<h4 id="读取媒体文件，分离音视频"><a href="#读取媒体文件，分离音视频" class="headerlink" title="读取媒体文件，分离音视频"></a>读取媒体文件，分离音视频</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化分离器和获取媒体各个轨道信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExtractor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化视频与音频分离器</span></span><br><span class="line">    mediaVideoExtractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">    mediaAudioExtractor = <span class="keyword">new</span> MediaExtractor();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 设置源</span></span><br><span class="line">        mediaVideoExtractor.setDataSource(filePath);</span><br><span class="line">        mediaAudioExtractor.setDataSource(filePath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环查找媒体轨道，此处只需要对一个分离器查找就可以了</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mediaVideoExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        MediaFormat mediaFormat = mediaVideoExtractor.getTrackFormat(i);</span><br><span class="line">        WushLog.e(mediaFormat.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 媒体类型</span></span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_MIME)) &#123;</span><br><span class="line">            String mime = mediaFormat.getString(MediaFormat.KEY_MIME);</span><br><span class="line">            WushLog.e(<span class="string">&quot;mine type: &quot;</span> + mime);</span><br><span class="line">            <span class="keyword">if</span> (mime.contains(VIDEO_MINE_PREFIX)) &#123;</span><br><span class="line">                videoMine = mime;</span><br><span class="line">                <span class="comment">// 轨道游标</span></span><br><span class="line">                videoTrackIndex = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mime.contains(AUDIO_MINE_PREFIX)) &#123;</span><br><span class="line">                audioMine = mime;</span><br><span class="line">                <span class="comment">// 轨道游标</span></span><br><span class="line">                audioTrackIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_WIDTH)) &#123;</span><br><span class="line">            <span class="comment">// 分辨率宽</span></span><br><span class="line">            videoWidth = mediaFormat.getInteger(MediaFormat.KEY_WIDTH);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_HEIGHT)) &#123;</span><br><span class="line">            <span class="comment">// 分辨率高</span></span><br><span class="line">            videoHeight = mediaFormat.getInteger(MediaFormat.KEY_HEIGHT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_FRAME_RATE)) &#123;</span><br><span class="line">            <span class="comment">// 帧率</span></span><br><span class="line">            <span class="keyword">int</span> rate = mediaFormat.getInteger(MediaFormat.KEY_FRAME_RATE);</span><br><span class="line">            <span class="keyword">if</span> (rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                frameRate = rate;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_SAMPLE_RATE)) &#123;</span><br><span class="line">            <span class="comment">// 采样率</span></span><br><span class="line">            sampleRate = mediaFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_BIT_RATE)) &#123;</span><br><span class="line">            <span class="comment">// 比特率</span></span><br><span class="line">            bitRate = mediaFormat.getInteger(MediaFormat.KEY_BIT_RATE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_CHANNEL_COUNT)) &#123;</span><br><span class="line">            <span class="comment">// 通道数</span></span><br><span class="line">            channelCount = mediaFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(<span class="string">&quot;bits-per-sample&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 音频采样位数（不一定存在）</span></span><br><span class="line">            bitsPerSample = mediaFormat.getInteger(<span class="string">&quot;bits-per-sample&quot;</span>);</span><br><span class="line">            WushLog.e(<span class="string">&quot;bitsPerSample: &quot;</span> + bitsPerSample);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mediaFormat.containsKey(MediaFormat.KEY_DURATION)) &#123;</span><br><span class="line">            <span class="keyword">long</span> duration = mediaFormat.getLong(MediaFormat.KEY_DURATION);</span><br><span class="line">            WushLog.e(<span class="string">&quot;duration: &quot;</span> + duration);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化Codec"><a href="#初始化Codec" class="headerlink" title="初始化Codec"></a>初始化Codec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化 Codec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initCodec</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建视频解码器</span></span><br><span class="line">        mediaVideoCodec = MediaCodec.createDecoderByType(videoMine);</span><br><span class="line">        <span class="comment">// 获取轨道格式</span></span><br><span class="line">        MediaFormat format = mediaVideoExtractor.getTrackFormat(videoTrackIndex);</span><br><span class="line">        <span class="comment">// 配置轨道信息和 Surface渲染容器</span></span><br><span class="line">        mediaVideoCodec.configure(format, surfaceHolder.getSurface(), <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        surfaceHolder.addCallback(<span class="keyword">new</span> SurfaceHolder.Callback2() &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(<span class="meta">@NonNull</span> SurfaceHolder surfaceHolder)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    isPlaying = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启视频解码器</span></span><br><span class="line">        mediaVideoCodec.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建音频解码器</span></span><br><span class="line">        mediaAudioCodec = MediaCodec.createDecoderByType(audioMine);</span><br><span class="line">        MediaFormat audioFormat = mediaAudioExtractor.getTrackFormat(audioTrackIndex);</span><br><span class="line">        <span class="comment">// 音频无需容器渲染，解码后使用AudioTrack播放，所以surface参数输入 null</span></span><br><span class="line">        mediaAudioCodec.configure(audioFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 开启音频解码器</span></span><br><span class="line">        mediaAudioCodec.start();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化AudioTrack"><a href="#初始化AudioTrack" class="headerlink" title="初始化AudioTrack"></a>初始化AudioTrack</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化AudioTrack</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAudioTrack</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声道数（通道数）</span></span><br><span class="line">    <span class="keyword">int</span> channel;</span><br><span class="line">    <span class="keyword">if</span> (channelCount == <span class="number">1</span>) &#123;</span><br><span class="line">        channel = AudioFormat.CHANNEL_OUT_MONO;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        channel = AudioFormat.CHANNEL_OUT_STEREO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> mixAudioBufferSize = AudioTrack.getMinBufferSize(sampleRate, channel, AudioFormat.ENCODING_PCM_16BIT);</span><br><span class="line"></span><br><span class="line">    audioTrack = <span class="keyword">new</span> AudioTrack(</span><br><span class="line">        AudioManager.STREAM_MUSIC,      <span class="comment">// 播放类型：音乐</span></span><br><span class="line">        sampleRate,     <span class="comment">// 采样率</span></span><br><span class="line">        channel,        <span class="comment">// 通道</span></span><br><span class="line">        AudioFormat.ENCODING_PCM_16BIT,     <span class="comment">// 采样位数</span></span><br><span class="line">        mixAudioBufferSize / <span class="number">2</span>,     <span class="comment">// 缓冲区大小</span></span><br><span class="line">        AudioTrack.MODE_STREAM);        <span class="comment">//  播放模式：数据流动态写入，另一种是一次性写入</span></span><br><span class="line"></span><br><span class="line">    audioTrack.play();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程池</span></span><br><span class="line"><span class="comment">// 执行视频解码</span></span><br><span class="line">executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            startVideo();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 执行音频解码</span></span><br><span class="line">executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startAudio();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开启视频循环解码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startVideo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 切换到视频轨道</span></span><br><span class="line">    mediaVideoExtractor.selectTrack(videoTrackIndex);</span><br><span class="line"></span><br><span class="line">    isPlaying = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">long</span> currentVideoTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解码一个帧的时间</span></span><br><span class="line">    <span class="keyword">long</span> decodeTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (isPlaying) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前帧解码的开始时间</span></span><br><span class="line">        decodeTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取空闲输入 buffer 游标index</span></span><br><span class="line">        <span class="keyword">int</span> inputBufferIndex = mediaVideoCodec.dequeueInputBuffer(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取空闲 index对应的 buffer</span></span><br><span class="line">            ByteBuffer byteBuffer = mediaVideoCodec.getInputBuffer(inputBufferIndex);</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">            <span class="comment">// 从分离器中读取一帧数据</span></span><br><span class="line">            <span class="keyword">int</span> readBufferSize = mediaVideoExtractor.readSampleData(byteBuffer, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (readBufferSize &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 记录当前读取的时间戳（用于播放进度，音视频同步等等）</span></span><br><span class="line">                currentVideoTime = mediaVideoExtractor.getSampleTime();</span><br><span class="line">                <span class="comment">// 将buffer 输入到codec</span></span><br><span class="line">                mediaVideoCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>,</span><br><span class="line">                                                 readBufferSize, currentVideoTime, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 分离器移动到下一帧</span></span><br><span class="line">                mediaVideoExtractor.advance();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// readBufferSize &lt; 0，则代表为最后一帧数据</span></span><br><span class="line">                mediaVideoCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                                 <span class="number">0</span>, MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">        <span class="keyword">int</span> outputBufferIndex = mediaVideoCodec.dequeueOutputBuffer(bufferInfo, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        decodeTime = System.currentTimeMillis() - decodeTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 视频同步音频</span></span><br><span class="line">        <span class="keyword">long</span> syncOffset = currentVideoTime - currentAudioTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同步，线程休眠时间 = 帧率时间间隔 + 解码耗时 + 音视频速度差</span></span><br><span class="line">        <span class="keyword">long</span> sleepTime = (<span class="number">1000</span> / frameRate) - decodeTime + (syncOffset / <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (sleepTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(sleepTime);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同步锁，防止surface异步销毁异常</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isPlaying) &#123;</span><br><span class="line">                <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 解码后的数据渲染到 surface当中</span></span><br><span class="line">                    mediaVideoCodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">true</span>);</span><br><span class="line">                    outputBufferIndex = mediaVideoCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开启视频循环解码</span></span><br><span class="line"><span class="comment"> * 流程和视频一致</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAudio</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mediaAudioExtractor.selectTrack(audioTrackIndex);</span><br><span class="line"></span><br><span class="line">    currentAudioTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (isPlaying) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> inputBufferIndex = mediaAudioCodec.dequeueInputBuffer(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            ByteBuffer byteBuffer = mediaAudioCodec.getInputBuffer(inputBufferIndex);</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">            <span class="keyword">int</span> readBufferSize = mediaAudioExtractor.readSampleData(byteBuffer, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (readBufferSize &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                currentAudioTime = mediaAudioExtractor.getSampleTime();</span><br><span class="line"></span><br><span class="line">                mediaAudioCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>,</span><br><span class="line">                                                 readBufferSize, currentAudioTime, <span class="number">0</span>);</span><br><span class="line">                mediaAudioExtractor.advance();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                mediaAudioCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                                 <span class="number">0</span>, MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</span><br><span class="line">        <span class="keyword">int</span> outputBufferIndex = mediaAudioCodec.dequeueOutputBuffer(bufferInfo, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            ByteBuffer outputBuffer = mediaAudioCodec.getOutputBuffer(outputBufferIndex);</span><br><span class="line">            <span class="keyword">short</span>[] shorts = <span class="keyword">new</span> <span class="keyword">short</span>[bufferInfo.size / <span class="number">2</span>];</span><br><span class="line">			<span class="comment">// bytebuffer转 shorts，1字节 -&gt; 2字节，长度 =/ 2</span></span><br><span class="line">            outputBuffer.position(<span class="number">0</span>);</span><br><span class="line">            outputBuffer.asShortBuffer().get(shorts, <span class="number">0</span>, bufferInfo.size / <span class="number">2</span>);</span><br><span class="line">			<span class="comment">// 写入AudioTrack播放</span></span><br><span class="line">            audioTrack.write(shorts, <span class="number">0</span>, bufferInfo.size / <span class="number">2</span>);</span><br><span class="line">            </span><br><span class="line">            mediaAudioCodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">true</span>);</span><br><span class="line">            outputBufferIndex = mediaAudioCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="视频渲染"><a href="#视频渲染" class="headerlink" title="视频渲染"></a>视频渲染</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解码后的数据渲染到 surface当中</span></span><br><span class="line">mediaVideoCodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<h4 id="音频播放"><a href="#音频播放" class="headerlink" title="音频播放"></a>音频播放</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer outputBuffer = mediaAudioCodec.getOutputBuffer(outputBufferIndex);</span><br><span class="line"><span class="keyword">short</span>[] shorts = <span class="keyword">new</span> <span class="keyword">short</span>[bufferInfo.size / <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// bytebuffer转 shorts，1字节 -&gt; 2字节，长度 =/ 2</span></span><br><span class="line">outputBuffer.position(<span class="number">0</span>);</span><br><span class="line">outputBuffer.asShortBuffer().get(shorts, <span class="number">0</span>, bufferInfo.size / <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 写入AudioTrack播放</span></span><br><span class="line">audioTrack.write(shorts, <span class="number">0</span>, bufferInfo.size / <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<h4 id="音视频同步"><a href="#音视频同步" class="headerlink" title="音视频同步"></a>音视频同步</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 视频同步音频</span></span><br><span class="line"><span class="keyword">long</span> syncOffset = currentVideoTime - currentAudioTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步，线程休眠时间 = 帧率时间间隔 + 解码耗时 + 音视频速度差</span></span><br><span class="line"><span class="keyword">long</span> sleepTime = (<span class="number">1000</span> / frameRate) - decodeTime + (syncOffset / <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span> (sleepTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(sleepTime);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>音视频的 dts与 pts，即为每一个数据帧的解码时间和显示时间。（常用于音视频同步的属性，此处暂无用到）</p>
<p>音视频同步方案无非三种，本文使用方案1：</p>
<p>1、以音频为基准，视频同步音频</p>
<p>2、以视频为基准，音频同步视频</p>
<p>3、以系统时间为准，视频和音频同步系统流逝的时间</p>
<p>据研究表明，人对视觉的敏感度远比声觉低，所以方案1通常被用于直播和视频聊天，方案三则通常需要数据源比较高的稳定性。</p>
<h4 id="进度设置"><a href="#进度设置" class="headerlink" title="进度设置"></a>进度设置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pos 时间戳位置</span></span><br><span class="line"><span class="comment">// flag SEEK_TO_CLOSEST_SYNC = 2(距离最近一个关键帧开始) SEEK_TO_NEXT_SYNC = 1(下一个关键帧开始) SEEK_TO_PREVIOUS_SYNC = 0(上一个关键帧开始)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">seekTo</span><span class="params">(<span class="keyword">long</span> pos, <span class="keyword">int</span> flag)</span></span></span><br></pre></td></tr></table></figure>



<p>源码：…（链接后续补）</p>
<p><img src="/2020/12/29/Android-MediaExtractor&MediaCodec/2.gif"></p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Media/">Media</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/11/27/Android-CoordinatorLayout/"><span>Android - CoordinatorLayout</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1602489080558&amp;di=0dbbed72cc7f877b951b367d4a9ed292&amp;imgtype=0&amp;src=http%3A%2F%2Fattach.bbs.miui.com%2Fforum%2F201504%2F05%2F094406wb74eokgpu7fuxnz.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By WuShaohong</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>